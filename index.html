<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant 2D</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth Logic ---
        let db, auth, userId;
        let unsubscribe = null;

        const initFirebase = async () => {
            try {
                // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
                // I have filled this in with the details you provided.
                const firebaseConfig = {
                    apiKey: "AIzaSyAkPgNjaa28cKgbwDAByg0RfSHvuSvC1d8",
                    authDomain: "valo2d.firebaseapp.com",
                    projectId: "valo2d",
                    storageBucket: "valo2d.firebasestorage.app",
                    messagingSenderId: "807697574241",
                    appId: "1:807697574241:web:066e47b0e6652f55783d20",
                    measurementId: "G-JN6KXYHLYK"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check if the user is already authenticated
                const authStatePromise = new Promise(resolve => {
                    const unsubscribeAuth = auth.onAuthStateChanged(user => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = null;
                        }
                        unsubscribeAuth();
                        resolve();
                    });
                });
                await authStatePromise;

                // Sign in with the provided token if available
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    userId = auth.currentUser.uid;
                } else if (!userId) {
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                
                console.log("Firebase initialized. User ID:", userId);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // --- Game Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const messageBox = document.getElementById('messageBox');
        const singlePlayerButton = document.getElementById('singlePlayerButton');
        const multiPlayerButton = document.getElementById('multiPlayerButton');
        const gameContainer = document.getElementById('gameContainer');
        const gameMenu = document.getElementById('gameMenu');
        const playerNameInput = document.getElementById('playerName');

        let players = {};
        let bullets = [];
        let singlePlayerMode = false;
        let gameLoopId = null;
        let playerState = {};
        let isPlayerReady = false;
        let isGameStarted = false;
        let aiPlayer = null;
        let gameId = null;

        const playerSize = 20;
        const playerSpeed = 3;
        const bulletSpeed = 5;
        const bulletRadius = 3;
        const playerColor = '#4299e1'; // Tailwind blue-500
        const enemyColor = '#f56565'; // Tailwind red-500
        const bulletColor = '#fbd38d'; // Tailwind orange-200

        let keys = {};
        let mouse = { x: 0, y: 0, down: false };

        // Helper function to show messages
        function showMessage(message, color = 'bg-blue-500') {
            messageBox.textContent = message;
            messageBox.className = `p-2 rounded-lg text-white text-sm text-center transition-all duration-300 ${color}`;
            messageBox.style.opacity = '1';
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        // --- Game Logic Functions ---
        function resizeCanvas() {
            canvas.width = gameContainer.clientWidth;
            canvas.height = gameContainer.clientHeight;
        }

        function drawPlayer(player, color) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, playerSize, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, player.x, player.y + playerSize + 10);
        }

        function drawBullet(bullet) {
            ctx.fillStyle = bulletColor;
            ctx.beginPath();
            ctx.arc(bullet.x, bullet.y, bulletRadius, 0, Math.PI * 2);
            ctx.fill();
        }

        function distance(p1, p2) {
            return Math.hypot(p1.x - p2.x, p1.y - p2.y);
        }

        function isCollision(p1, p2) {
            return distance(p1, p2) < playerSize;
        }

        function updateGameState() {
            // Update player positions based on input
            if (keys['w'] || keys['W']) playerState.y -= playerSpeed;
            if (keys['s'] || keys['S']) playerState.y += playerSpeed;
            if (keys['a'] || keys['A']) playerState.x -= playerSpeed;
            if (keys['d'] || keys['D']) playerState.x += playerSpeed;

            // Keep player within canvas bounds
            playerState.x = Math.max(playerSize, Math.min(canvas.width - playerSize, playerState.x));
            playerState.y = Math.max(playerSize, Math.min(canvas.height - playerSize, playerState.y));
            
            // AI logic for single-player mode
            if (singlePlayerMode && aiPlayer) {
                // Simple AI: move towards the player
                const dx = playerState.x - aiPlayer.x;
                const dy = playerState.y - aiPlayer.y;
                const angle = Math.atan2(dy, dx);
                aiPlayer.x += Math.cos(angle) * aiPlayer.speed;
                aiPlayer.y += Math.sin(angle) * aiPlayer.speed;
                
                // Keep AI within bounds
                aiPlayer.x = Math.max(playerSize, Math.min(canvas.width - playerSize, aiPlayer.x));
                aiPlayer.y = Math.max(playerSize, Math.min(canvas.height - playerSize, aiPlayer.y));
                
                // Simple AI shooting
                if (Math.random() < 0.01) { // 1% chance to shoot each frame
                    const bullet = {
                        x: aiPlayer.x,
                        y: aiPlayer.y,
                        vx: Math.cos(angle) * bulletSpeed,
                        vy: Math.sin(angle) * bulletSpeed,
                        ownerId: 'ai',
                    };
                    bullets.push(bullet);
                }
            }

            // Update bullet positions and check for collisions
            bullets = bullets.filter(bullet => {
                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                // Remove bullets that are out of bounds
                if (bullet.x < 0 || bullet.x > canvas.width || bullet.y < 0 || bullet.y > canvas.height) {
                    return false;
                }

                // Check for bullet-player collision
                let hitPlayer = null;
                if (singlePlayerMode) {
                    if (bullet.ownerId !== 'player' && isCollision(bullet, playerState)) {
                        hitPlayer = playerState;
                    }
                } else { // Multiplayer
                    for (const playerId in players) {
                        const player = players[playerId];
                        if (bullet.ownerId !== playerId && isCollision(bullet, player)) {
                            hitPlayer = player;
                            break;
                        }
                    }
                }

                if (hitPlayer) {
                    if (hitPlayer.id === userId) {
                         // Only process hit for the local player
                        console.log("Player hit! Removing bullet.");
                        // This would be where you handle a 'hit' event in Firebase
                        // For this example, we'll just show a message.
                        showMessage("You were hit!", "bg-red-500");
                        // In a real game, this would decrement health or trigger a death state.
                    } else if (singlePlayerMode && bullet.ownerId === 'player' && isCollision(bullet, aiPlayer)) {
                        showMessage("AI was hit!", "bg-green-500");
                        // In a real game, this would decrement AI health.
                    }
                    return false; // Remove the bullet
                }
                
                return true; // Keep the bullet
            });
        }

        // --- Game Loop and Drawing ---
        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw all players
            if (singlePlayerMode) {
                drawPlayer(playerState, playerColor);
                if (aiPlayer) {
                    drawPlayer(aiPlayer, enemyColor);
                }
            } else {
                for (const playerId in players) {
                    const player = players[playerId];
                    const color = playerId === userId ? playerColor : enemyColor;
                    drawPlayer(player, color);
                }
            }

            // Draw all bullets
            bullets.forEach(drawBullet);
            
            updateGameState();
            
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        // --- Multiplayer Specific Functions ---
        const savePlayerState = async () => {
            if (!db || !userId || !gameId) {
                console.error("Firebase not ready to save state.");
                return;
            }
            const gameDocRef = doc(db, 'artifacts', appId, 'public/data/games', gameId);
            const playerDocRef = doc(gameDocRef, 'players', userId);
            try {
                await setDoc(playerDocRef, playerState);
            } catch (e) {
                console.error("Error writing player state to Firestore:", e);
            }
        };

        const listenForGameUpdates = () => {
            if (unsubscribe) {
                unsubscribe();
            }

            const gameRef = doc(db, 'artifacts', appId, 'public/data/games', gameId);
            const playersRef = collection(gameRef, 'players');
            unsubscribe = onSnapshot(playersRef, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const player = change.doc.data();
                    players[change.doc.id] = player;
                    if (change.type === 'removed') {
                        delete players[change.doc.id];
                        showMessage(`${player.name} left the game.`, "bg-yellow-500");
                    }
                });

                // Start the game loop once there's at least two players
                if (Object.keys(players).length >= 2 && !isGameStarted) {
                    isGameStarted = true;
                    gameLoop();
                    showMessage("Game started! Find and shoot your opponent.", "bg-green-500");
                } else if (Object.keys(players).length < 2 && isGameStarted) {
                    isGameStarted = false;
                    cancelAnimationFrame(gameLoopId);
                    showMessage("Waiting for another player...", "bg-red-500");
                }
            });
        };
        
        // --- Player Controls and Event Listeners ---
        window.addEventListener('keydown', (e) => {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });

        canvas.addEventListener('mousedown', (e) => {
            if (isPlayerReady) {
                mouse.down = true;
                const angle = Math.atan2(mouse.y - playerState.y, mouse.x - playerState.x);
                
                const bullet = {
                    x: playerState.x,
                    y: playerState.y,
                    vx: Math.cos(angle) * bulletSpeed,
                    vy: Math.sin(angle) * bulletSpeed,
                    ownerId: userId,
                };
                bullets.push(bullet);
            }
        });

        canvas.addEventListener('mouseup', () => {
            mouse.down = false;
        });
        
        // Mobile-friendly touch controls
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.touches[0].clientX - rect.left;
            mouse.y = e.touches[0].clientY - rect.top;
            
            const angle = Math.atan2(mouse.y - playerState.y, mouse.x - playerState.x);
            const bullet = {
                x: playerState.x,
                y: playerState.y,
                vx: Math.cos(angle) * bulletSpeed,
                vy: Math.sin(angle) * bulletSpeed,
                ownerId: userId,
            };
            bullets.push(bullet);
        });

        // --- Game Setup and Start ---
        const startSinglePlayer = () => {
            singlePlayerMode = true;
            gameMenu.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resizeCanvas();

            const playerName = playerNameInput.value || `Player_${Math.random().toString(36).substr(2, 5)}`;
            playerState = {
                name: playerName,
                x: canvas.width / 4,
                y: canvas.height / 2,
                id: 'player',
            };
            isPlayerReady = true;

            aiPlayer = {
                name: "AI Bot",
                x: canvas.width * 3 / 4,
                y: canvas.height / 2,
                speed: 1.5,
                id: 'ai',
            };

            gameLoop();
            showMessage("Single Player Mode started! Defeat the AI Bot.", "bg-green-500");
        };

        const startMultiPlayer = async () => {
            if (!playerNameInput.value) {
                showMessage("Please enter your name!", "bg-red-500");
                return;
            }

            singlePlayerMode = false;
            gameMenu.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resizeCanvas();

            // Initialize Firebase first
            await initFirebase();
            if (!userId) {
                showMessage("Failed to connect to Firebase. Cannot start multiplayer.", "bg-red-500");
                gameMenu.classList.remove('hidden');
                gameContainer.classList.add('hidden');
                return;
            }

            const gameRef = collection(db, 'artifacts', appId, 'public/data/games');
            const gameSnapshot = await getDocs(gameRef);
            let activeGames = gameSnapshot.docs.filter(doc => doc.data().players > 0);
            
            if (activeGames.length > 0) {
                gameId = activeGames[0].id;
                console.log("Joining existing game:", gameId);
            } else {
                gameId = crypto.randomUUID();
                console.log("Creating new game:", gameId);
            }

            playerState = {
                name: playerNameInput.value,
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                id: userId,
            };
            isPlayerReady = true;

            await savePlayerState();
            listenForGameUpdates();
            showMessage("Waiting for another player to join...", "bg-yellow-500");
        };

        // Event listeners for the menu buttons
        singlePlayerButton.addEventListener('click', startSinglePlayer);
        multiPlayerButton.addEventListener('click', startMultiPlayer);

        // Resize canvas on window resize
        window.addEventListener('resize', resizeCanvas);
        
        // Cleanup on page unload
        window.onbeforeunload = async () => {
            if (!singlePlayerMode && userId && gameId) {
                try {
                    const gameDocRef = doc(db, 'artifacts', appId, 'public/data/games', gameId);
                    const playerDocRef = doc(gameDocRef, 'players', userId);
                    await deleteDoc(playerDocRef);
                } catch (e) {
                    console.error("Error removing player on unload:", e);
                }
            }
        };

        // Initial setup
        resizeCanvas();
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Tailwind gray-900 */
            color: #e2e8f0; /* Tailwind gray-200 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        #gameMenu {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2d3748; /* Tailwind gray-700 */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }
        #gameMenu h1 {
            font-size: 2.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #48bb78; /* Tailwind green-500 */
            text-shadow: 0 0 10px #48bb78;
        }
        #playerName {
            padding: 0.75rem;
            width: 100%;
            border-radius: 0.5rem;
            border: 2px solid #a0aec0; /* Tailwind gray-400 */
            background-color: #4a5568; /* Tailwind gray-600 */
            color: white;
            margin-bottom: 1rem;
        }
        .button-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .game-button {
            padding: 1rem;
            font-size: 1.125rem;
            font-weight: bold;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
        }
        .single-player-button {
            background: linear-gradient(to right, #63b3ed, #4299e1); /* Tailwind blue gradient */
            color: white;
        }
        .multi-player-button {
            background: linear-gradient(to right, #48bb78, #38a169); /* Tailwind green gradient */
            color: white;
        }
        #gameContainer {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #gameCanvas {
            background-color: #2d3748; /* Tailwind gray-700 */
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1200px;
            height: 100%;
            max-height: 800px;
            cursor: crosshair;
        }
        #messageBox {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="gameMenu">
            <h1>Valorant 2D</h1>
            <input type="text" id="playerName" placeholder="Enter your name" class="rounded-lg">
            <div class="button-group">
                <button id="singlePlayerButton" class="game-button single-player-button">Single Player</button>
                <button id="multiPlayerButton" class="game-button multi-player-button">Multiplayer</button>
            </div>
        </div>
        <div id="gameContainer" class="hidden w-full h-full p-4">
            <canvas id="gameCanvas" class="w-full h-full"></canvas>
            <div id="messageBox"></div>
        </div>
    </div>
</body>
</html>
