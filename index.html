<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant 2D: The Ascent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d121c;
            color: #ffffff;
            overflow: hidden; /* Prevent scrolling */
        }
        canvas {
            background-color: #eee;
            display: block;
            width: 100%;
            height: 100%;
        }
        #messageBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: #2a3447;
            border: 2px solid #5d758c;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            display: none; /* Hidden by default */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .message-content {
            font-size: 1.1rem;
            color: #fff;
        }
        .button-shadow {
            box-shadow: 0 4px #0f1621;
            transition: all 0.1s ease;
        }
        .button-shadow:active {
            transform: translateY(2px);
            box-shadow: 0 2px #0f1621;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen w-screen p-4 gap-4">

    <!-- Left UI Panel -->
    <aside class="w-full md:w-1/4 h-1/2 md:h-full flex flex-col p-6 space-y-4 rounded-xl border border-red-500/50 bg-gray-900/50">
        <!-- Game Title -->
        <div class="text-2xl md:text-3xl font-bold text-white text-center mb-4">VALORANT 2D</div>
        <div class="flex-1 flex flex-col space-y-4">
            <!-- Game Status -->
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700">
                <h3 class="font-bold text-gray-400 mb-2">Game Status</h3>
                <p id="gameStatusEl" class="text-sm text-green-400">Loading...</p>
                <div class="mt-2 text-sm text-gray-400">
                    <span class="font-bold">App ID:</span> <span id="appIdEl">...</span>
                </div>
                <div class="mt-2 text-sm text-gray-400">
                    <span class="font-bold">User ID:</span> <span id="userIdEl">...</span>
                </div>
            </div>

            <!-- Player List -->
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 overflow-y-auto flex-1">
                <h3 class="font-bold text-gray-400 mb-2">Players</h3>
                <ul id="playerListEl" class="space-y-2 text-sm text-gray-300">
                    <!-- Player list will be dynamically populated here -->
                </ul>
            </div>

            <!-- Chat and Scoreboard - Placeholder for future features -->
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 flex-1">
                <h3 class="font-bold text-gray-400 mb-2">Chat</h3>
            </div>
            <div class="p-4 rounded-lg bg-gray-800 border border-gray-700 flex-1">
                <h3 class="font-bold text-gray-400 mb-2">Score</h3>
            </div>
        </div>
    </aside>

    <!-- Game Canvas -->
    <main class="w-full md:w-3/4 flex flex-col items-center justify-center relative bg-gray-900 rounded-xl border border-red-500/50">
        <canvas id="gameCanvas" class="rounded-xl"></canvas>
        
        <!-- Welcome/Join Modal -->
        <div id="welcomeModal" class="absolute z-50 p-6 rounded-lg border border-red-500/50 bg-gray-900/75 backdrop-blur-sm shadow-2xl transition-opacity duration-300">
            <h2 class="text-xl md:text-2xl font-bold text-center mb-4 text-white">Welcome to Valorant 2D</h2>
            <p class="text-sm md:text-base text-gray-300 text-center mb-6">
                Select your agent to join or create a game. Share the App ID with friends to play together.
            </p>
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-8">
                <div class="flex flex-col items-center text-center cursor-pointer transition-transform transform hover:scale-105" data-agent="jett">
                    <span class="text-3xl">ü™Ç</span>
                    <span class="text-sm md:text-base font-medium">Jett</span>
                    <span class="text-xs text-gray-400">[E] Dash</span>
                </div>
                <div class="flex flex-col items-center text-center cursor-pointer transition-transform transform hover:scale-105" data-agent="sova">
                    <span class="text-3xl">üèπ</span>
                    <span class="text-sm md:text-base font-medium">Sova</span>
                    <span class="text-xs text-gray-400">[E] Recon Dart</span>
                </div>
                <div class="flex flex-col items-center text-center cursor-pointer transition-transform transform hover:scale-105" data-agent="sage">
                    <span class="text-3xl">üîÆ</span>
                    <span class="text-sm md:text-base font-medium">Sage</span>
                    <span class="text-xs text-gray-400">[E] Barrier Orb</span>
                </div>
            </div>
            <button id="joinButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl button-shadow">
                JOIN GAME
            </button>
        </div>

        <!-- Message Box for Alerts -->
        <div id="messageBox" class="p-6 rounded-lg shadow-xl border border-gray-700 bg-gray-900">
            <p id="messageContent" class="text-center font-semibold"></p>
        </div>

    </main>

    <script type="module">
        // Game-related constants
        const mapWidth = 1024;
        const mapHeight = 768;
        const playerSize = 25;
        const playerSpeed = 3;
        const bulletSpeed = 8;
        const walls = [
            // Outer walls
            { x: 0, y: 0, width: mapWidth, height: 10 },
            { x: 0, y: 0, width: 10, height: mapHeight },
            { x: mapWidth - 10, y: 0, width: 10, height: mapHeight },
            { x: 0, y: mapHeight - 10, width: mapWidth, height: 10 },
            // Inner walls
            { x: 200, y: 200, width: 600, height: 10 },
            { x: 200, y: 200, width: 10, height: 400 },
            { x: 790, y: 200, width: 10, height: 400 },
            { x: 200, y: 600, width: 600, height: 10 },
        ];

        // UI elements
        const gameCanvas = document.getElementById('gameCanvas');
        const ctx = gameCanvas.getContext('2d');
        const gameStatusEl = document.getElementById('gameStatusEl');
        const appIdEl = document.getElementById('appIdEl');
        const userIdEl = document.getElementById('userIdEl');
        const welcomeModal = document.getElementById('welcomeModal');
        const joinButton = document.getElementById('joinButton');
        const playerListEl = document.getElementById('playerListEl');
        const messageBox = document.getElementById('messageBox');
        const messageContentEl = document.getElementById('messageContent');

        // Game state and data
        let db, auth;
        let localPlayerId = '';
        let localPlayerAgent = 'jett';
        let gameState = {
            players: {},
            bullets: {},
        };
        let lastUpdateTime = 0;
        const updateInterval = 1000 / 60; // 60 FPS

        // Input state
        const keys = {};
        const mouse = { x: 0, y: 0, clicked: false };

        // --- Utility Functions ---
        // Function to show a temporary message box
        function showMessage(message) {
            messageContentEl.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        // Check for collision between two rectangles
        function rectCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // --- Firebase Integration ---
        // Initializes Firebase and authenticates the user for a self-hosted environment
        async function initializeFirebase() {
            try {
                // IMPORTANT: Replace this with your own Firebase project configuration.
                // You can find this in your Firebase console under Project settings -> General.
                const firebaseConfig = {
                    apiKey: "AIzaSyDuDJAA5XCKSHcZJu3VRopCp9NpHvZR0Q0",
                    authDomain: "val2do.firebaseapp.com",
                    projectId: "val2do",
                    storageBucket: "val2do.firebasestorage.app",
                    messagingSenderId: "381572810948",
                    appId: "1:381572810948:web:6c2ceb2e4736753d1d2191"

                };

                // Define a hardcoded app ID for the game. This will be the name of your game room.
                const appId = 'my-valorant-2d-game';
                
                console.log("Using hardcoded Firebase configuration and game ID.");

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                gameStatusEl.textContent = 'Authenticating...';
                
                // Use anonymous sign-in, which is simple and requires no user input.
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;

                localPlayerId = user.uid;
                userIdEl.textContent = localPlayerId;
                gameStatusEl.textContent = 'Ready to Join';
                appIdEl.textContent = appId;
                console.log("Authenticated anonymously with user ID:", localPlayerId);

            } catch (error) {
                console.error('Firebase Auth Error:', error);
                gameStatusEl.textContent = 'Auth Failed';
                showMessage('Authentication failed. Please check your internet connection and try again.');
            }
        }

        // Handles joining an existing game or creating a new one if it doesn't exist
        async function joinOrCreateGame() {
            if (!db || !auth.currentUser) {
                console.error("Firebase not initialized or user not authenticated.");
                gameStatusEl.textContent = 'Join Failed';
                showMessage('Unable to join game. Authentication is not ready.');
                return;
            }

            const appId = 'my-valorant-2d-game'; // Using the hardcoded app ID
            const gameRoomRef = doc(db, 'artifacts', appId, 'public', 'data', 'gameRooms', 'room1');
            const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'players', localPlayerId);

            try {
                // Use a transaction to safely update the player list
                await runTransaction(db, async (transaction) => {
                    const gameRoomDoc = await transaction.get(gameRoomRef);

                    const playerState = {
                        x: Math.random() * mapWidth,
                        y: Math.random() * mapHeight,
                        color: '#' + Math.floor(Math.random()*16777215).toString(16),
                        agent: localPlayerAgent,
                        angle: 0,
                        lastShot: 0,
                    };
                    
                    // Create the player document
                    transaction.set(playerRef, playerState);

                    // Update the game room to indicate the player has joined
                    if (!gameRoomDoc.exists()) {
                        transaction.set(gameRoomRef, {
                            players: { [localPlayerId]: true },
                            createdAt: Date.now(),
                            map: 'ascent'
                        });
                    } else {
                        const players = gameRoomDoc.data().players || {};
                        players[localPlayerId] = true;
                        transaction.update(gameRoomRef, { players });
                    }
                });

                console.log("Successfully joined/created game room.");
                welcomeModal.style.display = 'none';
                gameStatusEl.textContent = 'In Game';
                setupGameListeners();
            } catch (error) {
                console.error('Transaction failed: ', error);
                gameStatusEl.textContent = 'Join Failed';
                showMessage('Failed to join game. Please check your connection and refresh.');
            }
        }

        // Sets up real-time listeners for game state changes in Firestore
        function setupGameListeners() {
            const appId = 'my-valorant-2d-game'; // Using the hardcoded app ID
            // Listen for player updates
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'players'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const playerId = change.doc.id;
                    const data = change.doc.data();
                    if (change.type === 'added' || change.type === 'modified') {
                        gameState.players[playerId] = { ...data, id: playerId };
                    } else if (change.type === 'removed') {
                        delete gameState.players[playerId];
                    }
                });
                updatePlayerListUI();
            });

            // Listen for bullet updates
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bullets'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const bulletId = change.doc.id;
                    const data = change.doc.data();
                    if (change.type === 'added') {
                        gameState.bullets[bulletId] = { ...data, id: bulletId };
                    } else if (change.type === 'removed') {
                        delete gameState.bullets[bulletId];
                    }
                });
            });
        }

        // Updates the player list UI element
        function updatePlayerListUI() {
            playerListEl.innerHTML = '';
            for (const playerId in gameState.players) {
                const player = gameState.players[playerId];
                const listItem = document.createElement('li');
                listItem.textContent = `${player.agent} (${playerId.substring(0, 5)})`;
                if (playerId === localPlayerId) {
                    listItem.classList.add('font-bold', 'text-green-500');
                }
                playerListEl.appendChild(listItem);
            }
        }

        // --- Game Logic ---
        function updateGame() {
            const now = Date.now();
            const elapsed = now - lastUpdateTime;
            if (elapsed < updateInterval) return;
            lastUpdateTime = now;

            const playerState = gameState.players[localPlayerId];
            if (!playerState) return;

            const newPos = { x: playerState.x, y: playerState.y };

            // Handle player movement based on keys
            if (keys['KeyW']) newPos.y -= playerSpeed;
            if (keys['KeyS']) newPos.y += playerSpeed;
            if (keys['KeyA']) newPos.x -= playerSpeed;
            if (keys['KeyD']) newPos.x += playerSpeed;

            // Check for collisions with walls before updating position
            const playerRect = { x: newPos.x, y: newPos.y, width: playerSize, height: playerSize };
            let collision = false;
            for (const wall of walls) {
                if (rectCollision(playerRect, wall)) {
                    collision = true;
                    break;
                }
            }

            if (!collision) {
                playerState.x = newPos.x;
                playerState.y = newPos.y;
            }

            // Handle shooting
            if (mouse.clicked && now - playerState.lastShot > 500) {
                const appId = 'my-valorant-2d-game'; // Using the hardcoded app ID
                const bulletRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'bullets'));
                const bulletState = {
                    x: playerState.x + playerSize / 2,
                    y: playerState.y + playerSize / 2,
                    angle: playerState.angle,
                    shooterId: localPlayerId,
                };
                setDoc(bulletRef, bulletState);
                playerState.lastShot = now;
            }

            // Update local player state in the database
            const appId = 'my-valorant-2d-game'; // Using the hardcoded app ID
            const localPlayerRef = doc(db, 'artifacts', appId, 'public', 'data', 'players', localPlayerId);
            setDoc(localPlayerRef, playerState);

            // Update bullet positions and check for collisions
            for (const bulletId in gameState.bullets) {
                const bullet = gameState.bullets[bulletId];
                bullet.x += Math.cos(bullet.angle) * bulletSpeed;
                bullet.y += Math.sin(bullet.angle) * bulletSpeed;

                // Check for bullet-wall collisions
                const bulletRect = { x: bullet.x, y: bullet.y, width: 5, height: 5 };
                let bulletCollision = false;
                for (const wall of walls) {
                    if (rectCollision(bulletRect, wall)) {
                        bulletCollision = true;
                        break;
                    }
                }

                // Check for bullet-player collisions (don't hit self)
                if (!bulletCollision && bullet.shooterId !== localPlayerId) {
                    const targetPlayer = gameState.players[localPlayerId];
                    if (targetPlayer) {
                        const targetRect = { x: targetPlayer.x, y: targetPlayer.y, width: playerSize, height: playerSize };
                        if (rectCollision(bulletRect, targetRect)) {
                            // Hit logic here (e.g., reduce health)
                            console.log(`Player ${localPlayerId} was hit by a bullet from ${bullet.shooterId}!`);
                            // For this version, we will just remove the bullet
                            bulletCollision = true;
                        }
                    }
                }

                // Remove bullet from database if it collides with a wall or hits a player
                if (bulletCollision) {
                    const appId = 'my-valorant-2d-game'; // Using the hardcoded app ID
                    const bulletRef = doc(db, 'artifacts', appId, 'public', 'data', 'bullets', bulletId);
                    deleteDoc(bulletRef);
                }
            }
        }

        // Main game loop function
        function drawGame() {
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            
            // Draw walls
            ctx.fillStyle = '#444';
            walls.forEach(wall => {
                ctx.fillRect(wall.x, wall.y, wall.width, wall.height);
            });

            // Draw players
            for (const playerId in gameState.players) {
                const player = gameState.players[playerId];
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, playerSize, playerSize);
            }

            // Draw bullets
            for (const bulletId in gameState.bullets) {
                const bullet = gameState.bullets[bulletId];
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
            }

            // Update the game state (player movement, shooting, etc.)
            updateGame();
            requestAnimationFrame(drawGame);
        }

        // --- Event Listeners and Setup ---
        // Resize canvas to fit the screen
        function resizeCanvas() {
            if (window.innerWidth >= 768) {
                gameCanvas.width = mapWidth;
                gameCanvas.height = mapHeight;
            } else {
                const size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.5);
                gameCanvas.width = size;
                gameCanvas.height = size * (mapHeight / mapWidth);
            }
        }
        window.addEventListener('resize', resizeCanvas);

        // Keyboard input handling
        document.addEventListener('keydown', (e) => keys[e.code] = true);
        document.addEventListener('keyup', (e) => keys[e.code] = false);

        // Mouse input handling
        gameCanvas.addEventListener('mousedown', (e) => {
            const rect = gameCanvas.getBoundingClientRect();
            mouse.x = e.clientX;
            mouse.y = e.clientY;
            mouse.clicked = true;
            if (gameState.players[localPlayerId]) {
                const dx = (e.clientX - rect.left) - gameState.players[localPlayerId].x;
                const dy = (e.clientY - rect.top) - gameState.players[localPlayerId].y;
                gameState.players[localPlayerId].angle = Math.atan2(dy, dx);
            }
        });
        gameCanvas.addEventListener('mouseup', () => mouse.clicked = false);
        gameCanvas.addEventListener('mousemove', (e) => {
            if (!gameState.players[localPlayerId]) return;
            const rect = gameCanvas.getBoundingClientRect();
            mouse.x = e.clientX;
            mouse.y = e.clientY;
            const dx = (e.clientX - rect.left) - gameState.players[localPlayerId].x;
            const dy = (e.clientY - rect.top) - gameState.players[localPlayerId].y;
            gameState.players[localPlayerId].angle = Math.atan2(dy, dx);
        });

        // Touch input handling for mobile
        gameCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = gameCanvas.getBoundingClientRect();
            mouse.x = touch.clientX;
            mouse.y = touch.clientY;
            mouse.clicked = true;
            if (gameState.players[localPlayerId]) {
                const dx = (touch.clientX - rect.left) - gameState.players[localPlayerId].x;
                const dy = (touch.clientY - rect.top) - gameState.players[localPlayerId].y;
                gameState.players[localPlayerId].angle = Math.atan2(dy, dx);
            }
        }, { passive: false });
        gameCanvas.addEventListener('touchend', () => mouse.clicked = false);
        gameCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = gameCanvas.getBoundingClientRect();
            mouse.x = touch.clientX;
            mouse.y = touch.clientY;
            if (gameState.players[localPlayerId]) {
                const dx = (touch.clientX - rect.left) - gameState.players[localPlayerId].x;
                const dy = (touch.clientY - rect.top) - gameState.players[localPlayerId].y;
                gameState.players[localPlayerId].angle = Math.atan2(dy, dx);
            }
        }, { passive: false });

        // Agent selection logic
        document.querySelectorAll('[data-agent]').forEach(agentEl => {
            agentEl.addEventListener('click', () => {
                // Remove selected class from all agents
                document.querySelectorAll('[data-agent]').forEach(el => el.classList.remove('bg-gray-700', 'p-2', 'rounded-md'));
                // Add selected class to the clicked agent
                agentEl.classList.add('bg-gray-700', 'p-2', 'rounded-md');
                localPlayerAgent = agentEl.getAttribute('data-agent');
            });
        });

        // Join button event listener
        joinButton.addEventListener('click', () => {
            joinOrCreateGame();
        });

        // --- Game Entry Point ---
        window.onload = function() {
            resizeCanvas();
            initializeFirebase();
            drawGame();
        }
    </script>
</body>
</html>
